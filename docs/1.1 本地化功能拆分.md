# a

大家好，在上节视频中。
我们根据 ant.design.x 官方示例。
快速搭建了一个 AI 对话界面。
在示例中，所有样式、组件及逻辑等。
都塞到了 index.tsx 页面。
中英文本地化都塞到了 local.ts 文件中。
单页面代码臃肿会带来多方面的问题。
例如：可读性差、职责不清、耦合度高等。
接下来我们将对示例进行重构。
重构遵循以下核心原则。
一、保持组件单一职责。
二、控制文件大小。
三、建立清晰的模块边界。
首先，我们来重构本地化功能。
打开 src.locales.local.ts 文件。
复制中文本地化定义部分。
在 locales 目录下新建 typings.d.ts。
文件主要为本地化增加类型支持。
使用 interface 定义名为 Ai.Chat.Locale 的对象类型.
把刚才复制的内容粘贴到这里。
为类型添加注释信息。
打开替换工具。
这里使用正则表达式匹配两个单引号之间的内容。
把它们替换为 string 类型。
执行全部替换。
这里有几条是两个反引号包裹的。
修改正则表达式。
再次全部替换。
这里还有一条内容中包含换行符的。
我们手动替换一下。
接下来，我们在 locales 目录下。
新建 en.ts 文件。
把 local.ts 文件中英文本地化内容剪切。
粘贴到 en.ts 文件中。
最后 export default。
导出英文本地化数据。
en.US ant.d 是 ant.d 组件的英文本地化数据。
en.US 是我们这个工具的本地化数据。
en.US.X 是 x 组件的英文本地化数据。
实际上我们这个文件导出的。
是一个合并后的数据。
as 后边的部分表示数据类型。
我们把 en.US 组件这个数据类型。
替换为我们定义的 Ai.Chat.Locale 类型。
继续新建 zh.ts 文件。
存放中文本地化数据。
从 local.ts 文件复制中文本地化数据。
粘贴到本文件中。
最后导出中文本地化数据。
同样将 zhCN 数据类型。
替换为 Ai.Chat.Locale 类型。
转到 Ai.Chat.Locale 定义。
在最后新增 theme.Auto、theme.Light、theme.Dark 类型。
为 zh.CN 添加上类型支持。
这样在缺少某个类型的时候。
就会得到提示.
在最后添加上缺少的类型。
英文本地化同样添加上类型支持。
最后添加上缺少的类型。
接下来，在 models 目录下。
新增 locales.ts 文件。
该文件主要职责（单一职责）。
是管理本地化相关的数据状态。
业务逻辑与异步副作用等。
边界内聚，只处理本地化相关的业务逻辑。

为了节省时间。
我把准备好的代码粘贴到文件中。
回到顶部。
这里我们引入了 store2 存储管理库。
用于将本地化设置持久化存储至 localStorage 中。
大家可以使用 npm 或 yarn 等包管理工具安装该库。
定义支持的语言类型。
语言设置存储到 localStorage 的键名。
配置每种语言的加载方式和显示标签。
使用动态导入 (import()) 按需加载语言包。
检测浏览器首选语言的函数。
根据 navigator.language 判断语言类型。
从本地存储读取用户设置的语言。
如果没有存储，则使用浏览器语言。
载入语言的函数。
先尝试从缓存加载。
异步按需加载语言包。
使用 Map 进行缓存，避免重复加载。
Use。Locale。Return 类型是 locales.ts 文件导出数据的类型。
is.Loading.Ref: 防止重复调用切换语言。
changeLocale 切换语言的函数.
使用 useCallback 缓存函数引用。
避免在组件重新渲染时创建新的函数实例。
异步切换语言.
处理加载状态.
更新状态和本地存储.
设置就绪状态.

useEffect 中初始化一次语言加载。
最后导出相关语言数据与设置方法。

转到 index.tsx 文件。
删除掉旧的本地化导入。
在 React 函数组件内使用 useModel ，
引入 locales。ts 文件中导出的 local 本地化数据对象。
在函数组件外部有一些对 local 对象的引用。
此时会出现错误提示。
我们暂且将这些依赖 local 对象的定义。
全部剪切。
粘贴到引入 local 对象的下方。
打开浏览器的预览界面。
可以看到此时应用的语言为简体中文。
打开浏览器开发工具。
应用程序标签，本地存储。
在右侧可以看到有一条密钥为 language。
值为 zh-Hans 的设置。
这就是我们的语言设置。
我们将值修改为 en。
然后，刷新页面。
可以看到应用的语言已经成功切换为英文了。
本节视频，我们重构了 AI 对话工具的语言模块。
非常感谢大家的观看。
